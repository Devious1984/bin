#!/bin/bash
# Gentoo upgrade script
# Uses doas - run as normal user

set -euo pipefail

# ----- Config -----
USE_DIR="/etc/portage/package.use"
MAX_BACKTRACK=30
MAX_RETRIES=5

# ----- Colors -----
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'
log() { echo -e "${GREEN}[*]${NC} $*"; }
warn() { echo -e "${YELLOW}[!]${NC} $*"; }
error() { echo -e "${RED}[X]${NC} $*" >&2; }
info() { echo -e "${BLUE}[i]${NC} $*"; }

# ----- Sync & news -----
log "Syncing Portage..."
doas emaint --auto sync || {
  error "Sync failed."
  exit 1
}

log "Checking news..."
doas eselect news read new 2>/dev/null || true

log "GLSA check..."
doas glsa-check --list --nocolor | grep -v "No affected" || true

# ----- Dry-run loop -----
retry=0
while ((retry < MAX_RETRIES)); do
  log "Dry-run (attempt $((retry + 1)))..."
  DRY_CMD=(doas emerge -pvDuN --with-bdeps=y --backtrack=$MAX_BACKTRACK @world)

  if DRY_OUT=$("${DRY_CMD[@]}" 2>&1); then
    echo "$DRY_OUT"
    log "Dry-run clean."
    break
  else
    echo "$DRY_OUT"

    if echo "$DRY_OUT" | grep -q "The following USE changes are necessary"; then
      if apply_use_changes "$DRY_OUT"; then
        ((retry++))
        continue
      else
        [[ $? == 2 ]] && exit 0
        error "Failed to apply USE changes."
        exit 1
      fi
    else
      error "Dry-run failed (not USE issue). Aborting."
      exit 1
    fi
  fi
done

((retry >= MAX_RETRIES)) && {
  error "Too many retries."
  exit 1
}

# ----- Confirm update -----
warn "Proceed with system update? (y/N)"
read -r ans
[[ ! "$ans" =~ ^[Yy]$ ]] && {
  log "Update cancelled."
  exit 0
}

# ----- Real update -----
log "Updating @world..."
doas emerge -pvDuN --with-bdeps=y --backtrack=$MAX_BACKTRACK @world || {
  error "emerge failed."
  exit 1
}

# ----- Config & cleanup -----
log "Handling config files..."
doas dispatch-conf || warn "dispatch-conf issues."

log "Depclean..."
doas emerge --depclean || warn "depclean warnings."

# ----- Final -----
log "Update complete!"
