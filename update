#!/bin/bash
# Gentoo system and kernel upgrade script
# Uses doas - run as normal user

set -euo pipefail

# ----- Config -----
USE_DIR="/etc/portage/package.use"
MAX_BACKTRACK=30
MAX_RETRIES=5
LOG_DIR="${HOME}/.local/share/gentoo-upgrade"
LOG_FILE="${LOG_DIR}/upgrade-$(date +%Y%m%d-%H%M%S).log"
KERNEL_DIR="/usr/src/linux"
CONFIG_FILE="${KERNEL_DIR}/.config"
JOBS=$(nproc)

# ----- Colors -----
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log() {
  echo -e "${GREEN}[*]${NC} $*" | tee -a "$LOG_FILE"
}
warn() {
  echo -e "${YELLOW}[!]${NC} $*" | tee -a "$LOG_FILE"
}
error() {
  echo -e "${RED}[X]${NC} $*" | tee -a "$LOG_FILE" >&2
}
info() {
  echo -e "${BLUE}[i]${NC} $*" | tee -a "$LOG_FILE"
}
section() {
  echo -e "${CYAN}========================================${NC}" | tee -a "$LOG_FILE"
  echo -e "${CYAN}$*${NC}" | tee -a "$LOG_FILE"
  echo -e "${CYAN}========================================${NC}" | tee -a "$LOG_FILE"
}

# ----- Helper functions -----
apply_use_changes() {
  local output="$1"

  warn "USE flag changes required. Apply automatically? (y/N)"
  read -r ans
  [[ ! "$ans" =~ ^[Yy]$ ]] && return 2

  log "Applying USE changes with autounmask..."
  if doas emerge --autounmask-write -pvDuN @world 2>&1 | tee -a "$LOG_FILE"; then
    log "Changes written. Reviewing with dispatch-conf..."
    doas dispatch-conf
    return 0
  else
    return 1
  fi
}

upgrade_kernel() {
  section "Kernel Upgrade"

  # Check if kernel directory exists
  if [[ ! -d "$KERNEL_DIR" ]]; then
    warn "Kernel directory $KERNEL_DIR not found. Skip kernel upgrade? (Y/n)"
    read -r ans
    [[ "$ans" =~ ^[Nn]$ ]] && exit 1
    return 0
  fi

  # Check for kernel updates
  KERNEL_UPDATE=$(doas emerge -pvuDN @world 2>/dev/null | grep "sys-kernel" || true)
  if [[ -z "$KERNEL_UPDATE" ]]; then
    info "No kernel package updates available."
    warn "Rebuild current kernel anyway? (y/N)"
    read -r ans
    [[ ! "$ans" =~ ^[Yy]$ ]] && return 0
  else
    log "Kernel packages to update:"
    echo "$KERNEL_UPDATE" | tee -a "$LOG_FILE"
  fi

  warn "Proceed with kernel upgrade? (y/N)"
  read -r ans
  [[ ! "$ans" =~ ^[Yy]$ ]] && {
    log "Kernel upgrade skipped."
    return 0
  }

  log "Current kernel: $(uname -r)"

  # Install new kernel sources if available
  if [[ -n "$KERNEL_UPDATE" ]]; then
    log "Installing new kernel sources..."
    doas emerge -v sys-kernel/gentoo-sources 2>&1 | tee -a "$LOG_FILE" || {
      error "Failed to install kernel sources."
      return 1
    }

    # Update symlink
    log "Updating /usr/src/linux symlink..."
    doas eselect kernel list
    LATEST_KERNEL=$(doas eselect kernel list | grep -v "^Available" | tail -1 | awk '{print $2}' | tr -d '[]')
    doas eselect kernel set "$LATEST_KERNEL"
    log "Selected kernel: $LATEST_KERNEL"
  fi

  log "Changing to kernel directory..."
  cd "$KERNEL_DIR" || {
    error "Failed to change to $KERNEL_DIR"
    return 1
  }

  log "Copying current config..."
  if [[ -f /proc/config.gz ]]; then
    doas zcat /proc/config.gz | doas tee "$CONFIG_FILE" >/dev/null
  elif [[ -f "/boot/config-$(uname -r)" ]]; then
    doas cp "/boot/config-$(uname -r)" "$CONFIG_FILE"
  else
    error "Cannot find current kernel config!"
    error "Locations checked: /proc/config.gz, /boot/config-$(uname -r)"
    return 1
  fi

  log "Running olddefconfig (applying defaults to new options)..."
  doas make olddefconfig 2>&1 | tee -a "$LOG_FILE"

  warn "Open menuconfig for manual changes? (y/N)"
  read -r ans
  if [[ "$ans" =~ ^[Yy]$ ]]; then
    doas make menuconfig
  fi

  log "Compiling kernel with -j${JOBS}..."
  KERNEL_START=$(date +%s)
  if ! doas make -j"$JOBS" 2>&1 | tee -a "$LOG_FILE"; then
    error "Kernel compilation failed!"
    return 1
  fi
  KERNEL_END=$(date +%s)
  KERNEL_ELAPSED=$((KERNEL_END - KERNEL_START))
  log "Kernel compiled in ${KERNEL_ELAPSED}s ($((KERNEL_ELAPSED / 60))m)"

  log "Installing modules..."
  doas make modules_install 2>&1 | tee -a "$LOG_FILE"

  log "Installing kernel (will rebuild initramfs via dracut)..."
  doas make install 2>&1 | tee -a "$LOG_FILE"

  log "Updating GRUB configuration..."
  if command -v grub-mkconfig &>/dev/null; then
    doas grub-mkconfig -o /boot/grub/grub.cfg 2>&1 | tee -a "$LOG_FILE"
  else
    warn "grub-mkconfig not found. Update bootloader manually!"
  fi

  NEW_KERNEL=$(ls -t /boot/vmlinuz-* | head -1 | sed 's|/boot/vmlinuz-||')
  log "New kernel installed: $NEW_KERNEL"

  # Cleanup old kernels
  OLD_KERNELS=$(ls /boot/vmlinuz-* 2>/dev/null | wc -l)
  if ((OLD_KERNELS > 3)); then
    warn "$OLD_KERNELS kernels in /boot. Clean old kernels? (y/N)"
    read -r ans
    if [[ "$ans" =~ ^[Yy]$ ]]; then
      log "Running eclean-kernel to keep latest 3..."
      if command -v eclean-kernel &>/dev/null; then
        doas eclean-kernel -n 3 2>&1 | tee -a "$LOG_FILE"
      else
        warn "eclean-kernel not found. Install: emerge app-admin/eclean-kernel"
      fi
    fi
  fi

  log "Kernel upgrade complete!"
  return 0
}

# ----- Setup -----
mkdir -p "$LOG_DIR"
section "Gentoo System Upgrade - $(date)"
log "Logs: $LOG_FILE"

# Check if running as root
if [[ $EUID -eq 0 ]]; then
  error "Don't run this script as root. Use doas instead."
  exit 1
fi

# Check if doas is configured
if ! doas true 2>/dev/null; then
  error "doas not working. Check configuration."
  exit 1
fi

# ----- Mode selection -----
echo
info "Select upgrade mode:"
info "  1) Full system upgrade (packages + kernel)"
info "  2) Packages only"
info "  3) Kernel only"
echo -n "Choice [1]: "
read -r MODE
MODE=${MODE:-1}

DO_PACKAGES=false
DO_KERNEL=false

case $MODE in
1)
  DO_PACKAGES=true
  DO_KERNEL=true
  ;;
2)
  DO_PACKAGES=true
  ;;
3)
  DO_KERNEL=true
  ;;
*)
  error "Invalid choice."
  exit 1
  ;;
esac

# ----- Pre-flight checks -----
if $DO_PACKAGES; then
  section "Pre-flight System Checks"

  # Check disk space
  PORTAGE_TMPDIR=$(doas portageq envvar PORTAGE_TMPDIR || echo "/var/tmp/portage")
  AVAILABLE_SPACE=$(df -BG "$PORTAGE_TMPDIR" | awk 'NR==2 {print $4}' | sed 's/G//')
  if ((AVAILABLE_SPACE < 5)); then
    error "Low disk space in $PORTAGE_TMPDIR: ${AVAILABLE_SPACE}GB available"
    warn "Consider cleaning with: doas rm -rf $PORTAGE_TMPDIR/*"
    warn "Proceed anyway? (y/N)"
    read -r ans
    [[ ! "$ans" =~ ^[Yy]$ ]] && exit 1
  else
    info "Disk space OK: ${AVAILABLE_SPACE}GB available in $PORTAGE_TMPDIR"
  fi

  # Check for failed builds
  if compgen -G "/var/tmp/portage/*/*/temp/build.log" >/dev/null; then
    warn "Found old build logs. Previous builds may have failed."
    info "Clean with: doas rm -rf /var/tmp/portage/*/*"
  fi

  # Check for config updates pending
  if [[ -n $(find /etc -name '._cfg????_*' 2>/dev/null) ]]; then
    warn "Config files need updating!"
    warn "Run dispatch-conf first? (y/N)"
    read -r ans
    if [[ "$ans" =~ ^[Yy]$ ]]; then
      doas dispatch-conf
    else
      warn "Continuing with pending config files..."
    fi
  fi
fi

# ----- Sync & news -----
if $DO_PACKAGES; then
  section "Syncing Portage"

  log "Syncing repositories..."
  if ! doas emaint --auto sync 2>&1 | tee -a "$LOG_FILE"; then
    error "Sync failed."
    exit 1
  fi

  log "Checking news..."
  NEWS_COUNT=$(doas eselect news count new 2>/dev/null || echo 0)
  if [[ $NEWS_COUNT -gt 0 ]]; then
    warn "$NEWS_COUNT unread news items!"
    doas eselect news list | tee -a "$LOG_FILE"
    warn "Read news now? (y/N)"
    read -r ans
    if [[ "$ans" =~ ^[Yy]$ ]]; then
      doas eselect news read new
    else
      warn "Remember to read: eselect news read"
    fi
  fi

  log "Checking GLSA security advisories..."
  GLSA_OUT=$(doas glsa-check --list --nocolor 2>&1 || true)
  if echo "$GLSA_OUT" | grep -v "No affected" | grep -q "^[0-9]"; then
    warn "Security vulnerabilities found:"
    echo "$GLSA_OUT" | grep "^[0-9]" | tee -a "$LOG_FILE"
  else
    info "No security vulnerabilities found."
  fi
fi

# ----- Check for major updates -----
if $DO_PACKAGES; then
  section "Checking for Updates"

  log "Analyzing package updates..."
  MAJOR_UPDATES=$(doas emerge -pvuDN @world 2>/dev/null | grep -E "^\[ebuild.*U.*\]" |
    grep -E "(gcc|glibc|python|perl|llvm|rust|sys-kernel)" || true)
  if [[ -n "$MAJOR_UPDATES" ]]; then
    warn "Major system packages will be updated:"
    echo "$MAJOR_UPDATES" | tee -a "$LOG_FILE"
    warn "These may require special handling. Continue? (y/N)"
    read -r ans
    [[ ! "$ans" =~ ^[Yy]$ ]] && exit 0
  fi
fi

# ----- Dry-run loop -----
if $DO_PACKAGES; then
  section "Package Update Dry-run"

  retry=0
  while ((retry < MAX_RETRIES)); do
    log "Dry-run attempt $((retry + 1))/$MAX_RETRIES..."
    DRY_CMD=(doas emerge -pvDuN --with-bdeps=y --backtrack=$MAX_BACKTRACK @world)

    if DRY_OUT=$("${DRY_CMD[@]}" 2>&1); then
      echo "$DRY_OUT" | tee -a "$LOG_FILE"
      log "Dry-run successful."
      break
    else
      echo "$DRY_OUT" | tee -a "$LOG_FILE"

      # Check for specific common issues
      if echo "$DRY_OUT" | grep -q "slot conflict"; then
        error "Slot conflict detected. May need manual intervention."
        error "Common fixes:"
        error "  1. doas emerge --depclean (clean old versions)"
        error "  2. doas emerge -C <package> (remove conflicting package)"
        error "  3. doas emerge @preserved-rebuild"
        exit 1
      fi

      if echo "$DRY_OUT" | grep -q "circular dependency"; then
        error "Circular dependency detected."
        error "Try: doas emerge --update --deep --newuse --tree @world"
        exit 1
      fi

      if echo "$DRY_OUT" | grep -q "The following USE changes are necessary"; then
        if apply_use_changes "$DRY_OUT"; then
          ((retry++))
          continue
        else
          [[ $? == 2 ]] && exit 0
          error "Failed to apply USE changes."
          exit 1
        fi
      else
        error "Dry-run failed. Check log: $LOG_FILE"
        exit 1
      fi
    fi
  done

  ((retry >= MAX_RETRIES)) && {
    error "Too many retries."
    exit 1
  }

  # ----- Show update summary -----
  log "Update summary:"
  PACKAGE_COUNT=$(echo "$DRY_OUT" | grep -c "^\[ebuild" || echo 0)
  info "Packages to update: $PACKAGE_COUNT"

  DOWNLOAD_SIZE=$(echo "$DRY_OUT" | grep "Size of downloads:" | awk '{print $(NF-1), $NF}')
  info "Download size: ${DOWNLOAD_SIZE:-Unknown}"

  # Estimate time
  ESTIMATED_MINUTES=$((PACKAGE_COUNT * 5))
  ESTIMATED_HOURS=$((ESTIMATED_MINUTES / 60))
  info "Estimated time: ~${ESTIMATED_HOURS}h $((ESTIMATED_MINUTES % 60))m (rough estimate)"

  # ----- Confirm update -----
  warn "Proceed with package update? (y/N)"
  read -r ans
  [[ ! "$ans" =~ ^[Yy]$ ]] && {
    log "Package update cancelled."
    if $DO_KERNEL; then
      warn "Continue with kernel upgrade only? (y/N)"
      read -r ans
      [[ ! "$ans" =~ ^[Yy]$ ]] && exit 0
    else
      exit 0
    fi
  }
fi

# ----- Real update -----
if $DO_PACKAGES; then
  section "Updating Packages"

  START_TIME=$(date +%s)

  if ! doas emerge -vDuN --with-bdeps=y --backtrack=$MAX_BACKTRACK @world 2>&1 | tee -a "$LOG_FILE"; then
    END_TIME=$(date +%s)
    ELAPSED=$((END_TIME - START_TIME))
    error "emerge failed after ${ELAPSED}s ($((ELAPSED / 60))m)"
    error "Check logs: $LOG_FILE"
    error "Resume with: doas emerge --resume"
    exit 1
  fi

  END_TIME=$(date +%s)
  ELAPSED=$((END_TIME - START_TIME))
  log "Package update completed in ${ELAPSED}s ($((ELAPSED / 60))m)"

  # ----- Preserved rebuild -----
  if doas emerge --list-sets 2>/dev/null | grep -q "@preserved-rebuild"; then
    PRESERVED_COUNT=$(doas emerge -p @preserved-rebuild 2>/dev/null | grep -c "^\[ebuild" || echo 0)
    if ((PRESERVED_COUNT > 0)); then
      warn "$PRESERVED_COUNT packages need rebuilding for preserved libraries"
      warn "Rebuild now? (Y/n)"
      read -r ans
      if [[ ! "$ans" =~ ^[Nn]$ ]]; then
        log "Rebuilding preserved libraries..."
        doas emerge -v @preserved-rebuild 2>&1 | tee -a "$LOG_FILE"
      else
        warn "Remember to run: doas emerge @preserved-rebuild"
      fi
    fi
  fi

  # ----- Config & cleanup -----
  section "Post-Update Maintenance"

  log "Checking config files..."
  if [[ -n $(find /etc -name '._cfg????_*' 2>/dev/null) ]]; then
    warn "Config files need updating!"
    warn "Run dispatch-conf now? (Y/n)"
    read -r ans
    if [[ ! "$ans" =~ ^[Nn]$ ]]; then
      doas dispatch-conf || warn "dispatch-conf had issues."
    else
      warn "Remember to run: doas dispatch-conf"
    fi
  fi

  log "Checking for orphaned packages..."
  DEPCLEAN_COUNT=$(doas emerge -pc 2>/dev/null | grep "All selected packages:" |
    grep -oE "[0-9]+" | head -1 || echo 0)

  if ((DEPCLEAN_COUNT > 0)); then
    warn "$DEPCLEAN_COUNT orphaned packages can be removed"
    warn "Run depclean now? (y/N)"
    read -r ans
    if [[ "$ans" =~ ^[Yy]$ ]]; then
      doas emerge --depclean 2>&1 | tee -a "$LOG_FILE" || warn "depclean had warnings."
    else
      warn "Remember to run: doas emerge --depclean"
    fi
  fi

  # ----- Post-update checks -----
  log "Running post-update checks..."

  # Check for broken links
  if command -v revdep-rebuild &>/dev/null; then
    info "Checking for broken library links..."
    if REVDEP_OUT=$(doas revdep-rebuild --pretend 2>&1); then
      if echo "$REVDEP_OUT" | grep -q "to be rebuilt"; then
        warn "Broken library dependencies detected!"
        warn "Run: doas revdep-rebuild"
      else
        log "No broken dependencies found."
      fi
    fi
  fi
fi

# ----- Kernel upgrade -----
if $DO_KERNEL; then
  upgrade_kernel || {
    error "Kernel upgrade failed!"
    exit 1
  }
fi

# ----- Module check -----
section "System Health Check"

if [[ -d /lib/modules/$(uname -r) ]]; then
  log "âœ“ Kernel modules OK for current kernel $(uname -r)"
else
  error "âš  Current kernel $(uname -r) has no modules directory!"
  error "This means you're running an old kernel."
  error "Reboot to use the new kernel."
fi

# Check if reboot needed
REBOOT_NEEDED=false
if $DO_KERNEL; then
  REBOOT_NEEDED=true
elif $DO_PACKAGES && [[ -n "$MAJOR_UPDATES" ]]; then
  if echo "$MAJOR_UPDATES" | grep -qE "sys-kernel|sys-libs/glibc|sys-apps/systemd|sys-apps/openrc"; then
    REBOOT_NEEDED=true
  fi
fi

# ----- Final summary -----
section "Upgrade Complete!"

if $DO_PACKAGES; then
  log "âœ“ Packages updated: $PACKAGE_COUNT"
  log "âœ“ Time taken: $((ELAPSED / 60))m ${ELAPSED% 60}s"
fi

if $DO_KERNEL; then
  log "âœ“ Kernel upgraded to: $(ls -t /boot/vmlinuz-* | head -1 | sed 's|/boot/vmlinuz-||')"
fi

log "âœ“ Full log: $LOG_FILE"

# Show what to do next
NEXT_STEPS=()
[[ ${PRESERVED_COUNT:-0} -gt 0 ]] && NEXT_STEPS+=("doas emerge @preserved-rebuild")
[[ ${DEPCLEAN_COUNT:-0} -gt 0 ]] && NEXT_STEPS+=("doas emerge --depclean")
[[ -n $(find /etc -name '._cfg????_*' 2>/dev/null) ]] && NEXT_STEPS+=("doas dispatch-conf")

if [[ ${#NEXT_STEPS[@]} -gt 0 ]]; then
  info "Recommended next steps:"
  for step in "${NEXT_STEPS[@]}"; do
    info "  - $step"
  done
fi

# ----- Reboot option -----
if $REBOOT_NEEDED; then
  warn "REBOOT REQUIRED for changes to take effect!"
  warn "Reboot now? (y/N)"
  read -r ans
  if [[ "$ans" =~ ^[Yy]$ ]]; then
    log "Rebooting in 5 seconds... (Ctrl+C to cancel)"
    sleep 5
    doas reboot
  else
    warn "Remember to reboot when convenient!"
  fi
fi

log "All done! ðŸŽ‰"
